#! /usr/bin/env bash

# test file for running executables
# from various filesystems paths
# relative, absolute, relative parent

if [ "${BASH_SOURCE[0]}" != "./test/bin/paths" ]; then
	echo "path must be run from the root of the repository (./test/bin/paths)";
	exit 1;
fi

function paths {
	local parent="`dirname ${BASH_SOURCE[0]}`";
	parent="`dirname "$parent"`";
	declare -A messages;
	messages["./bake"]="relative binary path ok";
	messages["${PWD}/bake"]="absolute symlink path ok";
	messages["${PWD}/bin/bake"]="absolute binary path ok";
	messages["../bin/bake"]="parent binary path ok";
	messages["../bake"]="parent symlink path ok";
	declare -a paths;
	paths+=( "./bake" );
	paths+=( "${PWD}/bake" );
	paths+=( "${PWD}/bin/bake" );

	local changed=false;
	# relative should come last
	paths+=( "../bin/bake" );
	paths+=( "../bake" );

	for path in ${paths[@]}
		do
			msg="${messages["$path"]}";
			# run the relative reference correctly
			if ! $changed && [[ "$path" =~ ^\.\./ ]]; then
				cd "$PWD/test";
				changed=true;
			fi
			if [ ! -x "$path" ]; then
				echo "$path is not executable";
				exit 1;
			fi
			"$path" list && echo "$msg ($path)";
			if [ $? -ne 0 ]; then
				echo "path test failed for $path";
				exit 1;
			fi
	done
}
paths;
exit 0;