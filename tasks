require 'executable';
require 'tasks/clean';
require 'tasks/list';

function tasks.initialize {
	executable validate 'ronn' 'git';
}

function __doc_copy {
	local man="${target}/man";
	mkdirp "$man";
	
	# copy all source .ronn to target/man
	local cmd="cp "${root}/doc/*.ronn" "${man}"";
	eval "$cmd";
	
	# also copy the index.* files over
	eval "cp "${root}/doc/index.*" "${man}"";
}

# generates the man page(s) into target/man
function tasks.doc.tmp {
	local ronn="${executables[ronn]}";
	local man="${target}/man";		
	__doc_copy;
	$ronn -w -s toc -r5 --markdown ${man}/*.ronn
}

# generates the man page documentation
# and attempts to push the gh-pages branch
# before switching back to develop
function tasks.doc {
	local ronn="${executables[ronn]}";
	local git="${executables[git]}";
	local man="${target}/man";
	
	__doc_copy;
	
	# check out the gh-pages branch
	$git checkout gh-pages > /dev/null 2>&1 || quit 1 "could not checkout gh-pages branch, may be dirty";
	
	# copy over the temporary man pages
	cmd="cp -f "${man}/*" "${root}"";
	
	cd "${root}" \
		&& rm -fv ./*.html \
		&& eval "$cmd" \
		&& $ronn -w -s toc -r5 --markdown ${man}/*.ronn \
		&& $git add . \
		&& $git commit -m "doc rebuild" \
		&& $git ls-files \
		&& $git push origin gh-pages \
		|| { $git checkout develop && quit 1 "could not rebuild docs"; };
	
	# switch back to the develop branch
	$git checkout develop;
}