: <<'ronn:markdown'
task-semver(7) -- semver task(s) for bake(1)
=============================================

## SYNOPSIS

Task(s) for bake(1) that handle working with the semantic versioning specification.

## DESCRIPTION

Command methods for semantic versioning, including semver(7) validation and creation of a project version descriptor.

## REQUIRE

In your tasks(7) file `require` the `semver` task(s) using:

	require 'tasks/semver';

## USAGE

To view the status of task-semver(7) files use the `semver.files` command.

	bake semver.files
	
To view *all* version information use the `semver.print` command.

	bake semver.print
	
If no files are present this command will exit with a non-zero exit code, otherwise it will print warnings for any missing files.

To validate a semver(7) use the `semver.valid` command.

	bake semver.valid 1.2.0-alpha.1+build.12f4e9
	
## FILES

All files are stored in the `${root}` of the project.

### PACKAGE

An npm(1) package descriptor (*package.json*) that stores semver(7) information in the `version` field.

### VERSION

A text file (*version*) containing the current semver(7) version.

### SEMVER

A JSON document (*semver.json*) generated by task-semver(7) containing version information for the project.

## BUGS

**task-semver** is written in bash and depends upon `bash` >= 4.

## COPYRIGHT

**task-semver** is copyright (c) 2012 muji <http://xpm.io>

## SEE ALSO

bake(1), semver(3), semver(7)
ronn:markdown

require 'semver';
require 'json';

# tasks for working with semver data
function tasks.semver {
	__semver.file;
	local semverfile="$_result";
	local semverstr;
	declare -A semverdoc;
	
	# create initial semver files from package.json
	if ! __semver.file.exists? && __semver.package.file.exists?; then
		console.info "%s < %s" "$semverfile" "$_result";
		# parse the package descriptor semver		
		__semver.package.parse;
		semverstr="$_result";
		if ! semver.valid? "$semverstr"; then
			__semver.invalid.quit "$semverstr";
		else
			__semver.version.file;
			local versionfile="$_result";
			
			# got a valid semver string from the package descriptor
			semverdoc[generator]="task-semver(7), do not edit this file manually use bake(1) with task-semver(7)";
			semverdoc[semver.version]="$semverstr";
			semver.callback() {
				local keys=( ${!semver[@]} );
				local key val;
				for key in ${keys[@]}
					do
						val="${semver[$key]}";
						semverdoc["semver.${key}"]="$val";
				done
				
				# test for the encoded JSON document
				json.stringify <<< "semverdoc";
				
				# create the version file
				echo "$semverstr" > "$versionfile" || __semver.file.write.quit "$versionfile";
				
				# create the semver.json file
				json.string > "$semverfile" || __semver.file.write.quit "$semverfile";
			}
			
			# parse the retrieved semver
			semver.parse "$semverstr" "semver.callback";
			method.remove "semver.callback";
		fi
	# files exist - manage version information
	elif __semver.file.exists?; then
		console.info "semver file %s exists" "$semverfile";
	fi
	return 0;
}

# tests if a semver is valid
function tasks.semver.test {
	local semver;
	if [ $# -eq 0 ]; then
		console.quit 1 "no semver specified to test";
	else
		if semver.valid? "$1"; then
			console.info "semver %s is ok" "$1";
		else
			__semver.invalid.warn "$1";
			__semver.invalid.quit "$1";
		fi
	fi
}

# prints semver file status
function tasks.semver.files {
	__semver.file;
	local semverfile="$_result";	
	__semver.package.file;
	local packagefile="$_result";
	__semver.version.file;
	local versionfile="$_result";
	if [ ! -f "$semverfile" ] && [ ! -f "$packagefile" ] && [ ! -f "$versionfile" ]; then
		__semver.files.missing.quit;
	else
		local file files=( "$packagefile" "$versionfile" "$semverfile" );
		for file in ${files[@]}
			do
				if [ -f "$file" ]; then
					__semver.file.exists.info "$file";
				else
					__semver.file.missing.warn "$file";
				fi
		done
		__semver.missing.files.info;
	fi
}

# prints all available version information
function tasks.semver.print {
	__semver.file;
	local semverfile="$_result";
	__semver.package.file;
	local packagefile="$_result";
	__semver.version.file;
	local versionfile="$_result";
	if [ ! -f "$semverfile" ] && [ ! -f "$packagefile" ] && [ ! -f "$versionfile" ]; then
		__semver.files.missing.quit;
	else
		if [ -f "$packagefile" ] && [ -r "$packagefile" ]; then
			__semver.package.parse;
			local packageversion="$_result";
			if semver.valid? "$packageversion"; then
				console.info "%s < %s" "$packageversion" "$packagefile";
			else
				__semver.invalid.warn "$packageversion";
			fi
		else
			__semver.file.missing.warn "$packagefile";
		fi
		
		if [ -f "$versionfile" ] && [ -r "$versionfile" ]; then
			# TODO: print version information
			echo -ne "";
		else
			__semver.file.missing.warn "$versionfile";
		fi
		
		if [ -f "$semverfile" ] && [ -r "$semverfile" ]; then
			# TODO: print semver version information
			echo -ne "";
		else
			__semver.file.missing.warn "$semverfile";
		fi
		__semver.missing.files.info;
	fi
}

function __semver.file.write.quit {
	console.quit 1 "could not write %s" "$1";
}

function __semver.invalid.warn {
	console.warn "semver %s is not ok" "$1";
}

function __semver.invalid.quit {
	console.quit 1 "invalid semver %s" "$1";
}

function __semver.file.exists.info {
	console.info "%s %s" "$1" "✓";
}

function __semver.files.missing.quit {
	console.quit 1 "no semver files available";	
}

function __semver.file.missing.warn {
	console.warn "%s %s" "$1" "✘";
}

function __semver.missing.files.info {
 	if [ -f "$packagefile" ] && [ ! -f "$semverfile" ] && [ ! -f "$versionfile" ]; then
		console.info "run %s to create files" "bake semver";
	fi	
}

function __semver.file.write! {
	echo "write semver version file ... ";
	return 0;
}

function __semver.file.exists? {
	__semver.file;
	test -f "$_result";
}

function __semver.package.file.exists? {
	__semver.package.file;
	test -f "$_result";
}

function __semver.package.parse {
	__semver.package.file;
	local srcfile="$_result";
	console.info "parsing %s" "$srcfile";
	# parse the semver
	json.parse < "$srcfile";
	_result="${json_doc[version]:-}";
	# clean the parsed json data, we're done
	json.clean;
}

function __semver.version.file {
	_result="${root}/version";
}

function __semver.package.file {
	_result="${root}/package.json";
}

function __semver.file {
	_result="${root}/semver.json";
}