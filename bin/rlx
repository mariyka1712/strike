#!/usr/bin/env bash

: <<'ronn:markdown'
rlx(1) -- couchdb command line interface
=============================================

## SYNOPSIS

A command line interface for couchdb(7).

## DESCRIPTION

Allows manipulation and querying of couchdb(7) databases from the command line.

## USAGE

	rlx shell [options...] [host]
	
## FILES

The rlx(1) program stores various configuration files in `$HOME/.rlx`.
	
## DEPENDENCIES

openssl(1), curl(1), tee(1)

## BUGS

**rlx** is written in bash and depends upon `bash` >= 4.2.

## COPYRIGHT

**rlx** is copyright (c) 2012 muji <http://xpm.io>

## SEE ALSO

couchdb(3), http(3), json(3), curl(1)
ronn:markdown

set -o errtrace;
set -o errexit;
set -o nounset;

######################################################################
#
#	BOILERPLATE
#
######################################################################
console_print_program_prefix="off";
declare -g exedir;
function boilerplate {
	local src="${BASH_SOURCE[0]}"
	exedir="$( dirname "$src" )"
	while [ -h "$src" ]
		do 
			src="$(readlink "$src")";
			[[ $src != /* ]] && src="$exedir/$src";
			exedir="$( cd -P "$( dirname "$src"  )" && pwd )";
	done
	exedir="$( cd -P "$( dirname "$src" )" && pwd )";
	unset src;
	source "$exedir/../lib/shared" "$@";
}
boilerplate "$@";
######################################################################

# switch on strict mode
process.use strict;

# configure help
require 'help';
help.man.page "default" "rlx.1";
help.parse "$@";

# if [ $# -eq 0 ]; then
# 	help.man.show.default;
# 	exit 0;
# fi

declare -g rlx_prompt_prefix="[rlx]";
declare -g rlx_prompt="${rlx_prompt_prefix} %s";
declare -g rlx_prompt_suffix=" ⚡ ";

declare -g rlx_home="$HOME/.rlx";

function rlx.init {
	local db="db";
	local keys="keys";
	local log="log";
	local dir subdirs=( "$keys" "$db" "$log" );
	# create main storage directory
	mkdir -p "$rlx_home" \
		|| console.quit 1 "could not create %s" "$rlx_home";
	if [ -d "$rlx_home" ]; then
		console.info "created %s" "$rlx_home";
	fi
	# create required sub-directories
	for dir in "${subdirs[@]}"
		do
			dir="${rlx_home}/${dir}";
			mkdir -p "$dir" \
				|| console.quit 1 "could not create %s" "$dir";
			if [ -d "$dir" ]; then
				console.info "created %s" "$dir";
			fi
	done
	local keylogfile="${rlx_home}/${log}/keygen.log";
	local keydir="${rlx_home}/$keys";
	local keypair="${keydir}/rlx.pem";
	local keypublic="${keydir}/rlx.pub";
	# generate the keypair and public key
	crypto.rsa.generate false 2048 "$keypair" "$keypublic" "$keylogfile" \
		|| console.quit 1 "failed to generate private/public key pair";
	chmod -R 700 "$keydir" || console.quit 1 "could not change permissions on %s" "$keydir";
	if [ -f "$keypair" ]; then
		console.info "generated public/private keypair %s" "$keypair";
	fi
	if [ -f "$keypublic" ]; then
		console.info "generated public key file %s" "$keypublic";
	fi
	return 0;
}

function rlx.firstrun? {
	test -d "$rlx_home";
}

function rlx.prompt {
	local replace="${1:-}";
	local ps1=$( printf "$rlx_prompt" "$replace" );
	#echo -n "${ps1}${rlx_prompt_suffix}";
	prompt="${ps1}${rlx_prompt_suffix}";
}

function rlx.shell {
	echo "$FUNCNAME : $*";
	
	host="${1:-}";
	
	# TODO: add prompt to specify the host?
	if [ $# -eq 0 ]; then
		console.quit 1 "no host specified";
	fi
	
	# TODO: test if db-name has been specified
	
	# /_all_dbs
	# ["fastdrop","hosts","rlx-world-writable"]
	
	console.info "host %s" "$host";
	couchdb.db.list "$host";
	
	rlx.response;
	
	#echo "got response status: $http_response_status";
}

# handle a server response
function rlx.response {
	if [ $http_response_status -eq 401 ]; then
		console.warn "authorization required for %s" "$host";
		if [ -v PS1 ]; then
			console.quit 1 "not a tty, cannot prompt for authentication credentials";
		else
			rlx.prompt "username";
			read -p "${prompt}" username;
			rlx.prompt "password";
			read -s -p "${prompt}" password;
			# create the newline
			echo "";
			echo "username: $username, password: $password";
		fi
	fi
}

function rlx {
	# we need these executables so test early
	executable.validate openssl curl tee;
	
	# the current host being used
	local host="";
	
	# the current prompt
	local prompt="${rlx_prompt_prefix}${rlx_prompt_suffix}";
	
	# credentials used for authentication
	local username;
	local password;
	
	# dependencies
	require 'inet';
	require 'couchdb';
	require 'crypto';
	
	if ! rlx.firstrun?; then
		rlx.init;
	fi
	
	# TODO: get this from a --host option
	local host="ffsys.cloudant.com";
	local protocol="http://";
	
	# https://ffsys.cloudant.com/rlx-world-writable/
	
	# TODO: only run this test when the host is not
	# TODO: localhost or 127.0.0.1
	
	# set +e;
	# # TODO: change this to use curl(1) for inet validation
	# inet.up? "$host";
	# if [ $? -gt 0 ]; then
	# 	console.quit 1 "could not connect to %s %s" "$host" "✘";
	# fi
	# set -e;
	# 
	# console.info "%s ok %s" "$host" "✓";
	local cmd="${1:-}";
	shift;
	echo "got cmd: $cmd";
	
	delegate "rlx" "$cmd" "$@" || quit $? "command %s failed" "$cmd";
}

rlx "$@";