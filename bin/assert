#!/usr/bin/env bash

: <<'ronn:markdown'
assert(1) -- unit test runner for strike(1)
=============================================

## SYNOPSIS

`assert` test [<unit>...]<br>

## DESCRIPTION

**assert** runs strike(1) unit tests.

## BUGS

**assert** is written in bash and depends upon `bash` >= 4.

## COPYRIGHT

**assert** is copyright (c) 2012 muji <http://xpm.io>

## SEE ALSO

strike(1)
ronn:markdown

set -o errtrace;
set -o errexit;
set -o nounset;

######################################################################
#
#	BOILERPLATE
#
######################################################################
export PROGRAM_NAME=`basename $0`;
program_config_print_welcome="off";
program_config_print_prefix="off";
declare -gx exedir;
function boilerplate {
	local abspath=$(cd ${BASH_SOURCE[0]%/*} && echo $PWD/${0##*/});
	if [ -L "$abspath" ]; then
		abspath=`readlink $abspath`;
	fi
	exedir=`dirname "$abspath"`;
	local libdir="$exedir/../lib";
	source "$libdir/shared";
}
boilerplate;
######################################################################

#method.list;
require 'help';
#method.list;
exit 0;

require 'options';

# configure help
help.man.page "default" "assert.1";
help.parse "$@";

# set up the main delegate module as 'assert'
module="$PROGRAM_NAME";

options_minimum=1;
options_expects_command=( "test" );
options_map_command_method=1;

#configure all the option defaults
options configure;

#parse the parameters
options parse "$@";

function assert_test {	
	if [ $# -eq 0 ]; then
		quit 1 "no tests specified";
	fi
	
	local opts=( "$@" );
	local searchpaths=(
		"$exedir/test"
		"$exedir/../test"
	);
	local unit path file;
	for path in ${searchpaths[@]}
		do
			for unit in ${opts[@]}
				do
					file="${path}/${unit}.test";
					if [ -f "$file" ]; then
						__assert_run_test "$file";
					fi
			done
	done
}

function assert.expects {
	echo "expects called with : $1";
}

function __assert_run_test {
	
	require.list;	
	local file="$1";
	echo "running test: $file";
	
	require "$file" || quit 1 "could not require test file %s" "$file";
	
	require.list;	
}

main "${module:-}" "${options_command_method:-}" "${module_options[@]:-}";

exit 0;